<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Comparar precio de Leche</title>
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 2rem; }
    .card {
      background: white;
      margin: 1rem 0;
      padding: 1rem;
      border-left: 4px solid #007BFF;
      border-radius: 6px;
    }
    .barato {
      border-left-color: green;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>ğŸ¼ Comparador: Leche La SerenÃ­sima Zerolact 1L</h1>
<div id="result">Buscando precios...</div>

<script>
  const lat = -32.9252;
  const lng = -68.8443;
  const term = "zerolact 1l";
  const resultDiv = document.getElementById('result');

  fetch(`https://d3e6htiiul5ek9.cloudfront.net/prod/sucursales?lat=${lat}&lng=${lng}&limit=5`)
    .then(res => res.json())
    .then(async data => {
      if (!data.sucursales || data.sucursales.length === 0) {
        resultDiv.innerHTML = "âŒ No se encontraron sucursales.";
        return;
      }

      let resultados = [];

      for (const suc of data.sucursales) {
        const res = await fetch('api_productos.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sucursalId: suc.sucursalId, term })
        });

        const productos = await res.json();

        if (Array.isArray(productos)) {
          const item = productos.find(p =>
            p.producto.descripcion.toLowerCase().includes("zerolact")
          );

          if (item) {
            resultados.push({
              nombre: suc.sucursalNombre,
              direccion: suc.direccion,
              precio: item.precio
            });
          }
        }
      }

      if (resultados.length === 0) {
        resultDiv.innerHTML = "âŒ No se encontrÃ³ la leche Zerolact en las sucursales.";
        return;
      }

      resultados.sort((a, b) => a.precio - b.precio);

      resultDiv.innerHTML = "";
      resultados.forEach((r, i) => {
        resultDiv.innerHTML += `
          <div class="card ${i === 0 ? 'barato' : ''}">
            ğŸ¬ <strong>${r.nombre}</strong><br>
            ğŸ“ ${r.direccion}<br>
            ğŸ’² Precio: $${r.precio.toFixed(2)}
          </div>
        `;
      });
    })
    .catch(err => {
      console.error(err);
      resultDiv.innerHTML = "âŒ Error general al buscar precios.";
    });
</script>

</body>
</html>
