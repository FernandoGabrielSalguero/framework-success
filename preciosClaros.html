<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>¿Dónde compro más barato?</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; background: #f5f5f5; }
    input, button { padding: 0.5rem; font-size: 1rem; margin-right: 0.5rem; }
    .producto { background: white; margin: 1rem 0; padding: 1rem; border-left: 5px solid #28a745; border-radius: 6px; }
    .error { color: red; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>🛒 ¿Dónde compro más barato?</h1>

  <input type="text" id="termino" placeholder="Ej: leche, arroz, yerba...">
  <button onclick="agregarAlCarrito()">Agregar al carrito</button>

  <h2>🧺 Carrito</h2>
  <ul id="carrito"></ul>
  <button onclick="comparar()">🔍 Comparar precios</button>

  <h2>💲 Resultados</h2>
  <div id="resultados"></div>
  <div class="error" id="error"></div>

  <script>
    const carrito = [];

    function agregarAlCarrito() {
      const termino = document.getElementById('termino').value.trim();
      if (termino && !carrito.includes(termino)) {
        carrito.push(termino);
        actualizarCarrito();
        document.getElementById('termino').value = '';
      }
    }

    function actualizarCarrito() {
      const ul = document.getElementById('carrito');
      ul.innerHTML = carrito.map(item => `<li>${item}</li>`).join('');
    }

    async function comparar() {
      const resultados = document.getElementById('resultados');
      const error = document.getElementById('error');
      resultados.innerHTML = 'Buscando sucursales...';
      error.textContent = '';

      const lat = -32.9252;
      const lng = -68.8443;

      try {
        const resSuc = await fetch(`https://d3e6htiiul5ek9.cloudfront.net/prod/sucursales?lat=${lat}&lng=${lng}&limit=5`);
        const dataSuc = await resSuc.json();
        const sucursales = dataSuc.sucursales;

        if (!sucursales || sucursales.length === 0) {
          resultados.innerHTML = '❌ No se encontraron sucursales.';
          return;
        }

        resultados.innerHTML = 'Buscando productos...';

        let comparativa = [];

        for (const suc of sucursales) {
          for (const term of carrito) {
            const query = new URLSearchParams({
              sucursalId: suc.sucursalId,
              term: term
            });

            const resProd = await fetch(`api_productos.php?${query.toString()}`);
            if (!resProd.ok) continue;

            const productos = await resProd.json();

            for (const item of productos) {
              comparativa.push({
                descripcion: item.producto.descripcion,
                precio: item.precio,
                sucursal: suc.sucursalNombre,
                direccion: suc.direccion
              });
            }
          }
        }

        if (comparativa.length === 0) {
          resultados.innerHTML = '❌ No se encontraron productos.';
          return;
        }

        comparativa.sort((a, b) => a.precio - b.precio);

        resultados.innerHTML = comparativa.map(p => `
          <div class="producto">
            <strong>${p.descripcion}</strong><br>
            Precio: $${p.precio.toFixed(2)}<br>
            Sucursal: ${p.sucursal}<br>
            Dirección: ${p.direccion}
          </div>
        `).join('');

      } catch (err) {
        console.error(err);
        error.textContent = '❌ Error general al buscar precios.';
        resultados.innerHTML = '';
      }
    }
  </script>
</body>
</html>
